name: JavaScript Producer

on:
  push:
    paths:
      - '**.user.js'
      - '.github/workflows/**'
  pull_request:
    paths:
      - '**.user.js'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  TERSER_OPTIONS: '--compress drop_console=true,pure_funcs=[console.log] --mangle --comments false'
  USERJS_DIR: 'userjs'
  TZ: 'Asia/Ho_Chi_Minh'  # Set timezone to Vietnam

jobs:
  process-js:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm install -g terser

      - name: Initialize workspace
        id: init
        run: |
          mkdir -p "${{ env.USERJS_DIR }}"
          touch "${{ env.USERJS_DIR }}/.gitkeep"
          echo "# Checksums generated on $(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S GMT%z')" > "${{ env.USERJS_DIR }}/checksums.txt"
          echo "initial_count=$(find . -name "*.user.js" -not -path "./${{ env.USERJS_DIR }}/*" | wc -l)" >> $GITHUB_OUTPUT

      - name: Process JavaScript files
        id: process
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          calculate_checksums() {
            local file="$1"
            local base="$2"
            local target_dir="$3"
            
            # Calculate multiple checksums
            {
              echo "SHA-256: $(sha256sum "$file" | cut -d' ' -f1)"
              echo "MD5: $(md5sum "$file" | cut -d' ' -f1)"
              echo "SHA-1: $(sha1sum "$file" | cut -d' ' -f1)"
            } >> "$target_dir/checksums.txt"
            echo "File: ${base}.user.js" >> "$target_dir/checksums.txt"
            echo "---" >> "$target_dir/checksums.txt"
          }
          
          process_script() {
            local file="$1"
            local filename=$(basename "$file")
            local base="${filename%.user.js}"
            local target_dir="${{ env.USERJS_DIR }}"
            
            echo "Processing $filename..."
            
            # Extract and validate metadata with improved multilingual support
            meta_block=$(awk '/\/\/ ==UserScript==/{p=1;print;next}/\/\/ ==\/UserScript==/{p=0;print;exit}p{print}' "$file")
            
            # Enhanced multilingual metadata extraction
            get_meta_value() {
              local pattern="$1"
              local meta="$2"
              local langs=("vi" "en" "") # Priority order: Vietnamese, English, Default
              
              for lang in "${langs[@]}"; do
                local suffix=""
                [ -n "$lang" ] && suffix=":$lang"
                local value=$(echo "$meta" | grep -m 1 "@${pattern}${suffix}" | sed -E "s/\/\/ @${pattern}${suffix}\s+//")
                [ -n "$value" ] && echo "$value" && return
              done
            }

            # Get metadata values
            local name=$(get_meta_value "name" "$meta_block")
            local description=$(get_meta_value "description" "$meta_block")
            local version=$(echo "$meta_block" | grep -m 1 "@version" | sed -E 's/\/\/ @version\s+//')
            local author=$(echo "$meta_block" | grep -m 1 "@author" | sed -E 's/\/\/ @author\s+//')
            
            # Validate required metadata
            if [ -z "$name" ] || [ -z "$description" ] || [ -z "$version" ] || [ -z "$author" ]; then
              echo "::error::Missing required metadata in $filename"
              return 1
            fi
            
            # Update metadata URLs and add Vietnam timezone
            meta_block=$(echo "$meta_block" | sed -E "
              s|^// @downloadURL .*|// @downloadURL https://github.com/$GITHUB_REPOSITORY/raw/main/$target_dir/${base}.user.js|
              s|^// @updateURL .*|// @updateURL https://github.com/$GITHUB_REPOSITORY/raw/main/$target_dir/${base}.meta.js|
              s|^// @supportURL .*|// @supportURL https://github.com/$GITHUB_REPOSITORY/issues|
              /^\/\/ ==\/UserScript==/ i // @lastModified $(TZ='Asia/Ho_Chi_Minh' date +"%Y-%m-%d %H:%M:%S GMT%z")
            ")
            
            # Process and minify code
            {
              echo "$meta_block"
              awk '/\/\/ ==\/UserScript==/{p=1;next}p{print}' "$file" | terser ${{ env.TERSER_OPTIONS }}
            } > "$target_dir/${base}.user.js"
            
            # Save metadata
            echo "$meta_block" > "$target_dir/${base}.meta.js"
            
            # Calculate and save multiple checksums
            calculate_checksums "$target_dir/${base}.user.js" "$base" "$target_dir"
            
            echo "âœ“ Processed: $filename"
            return 0
          }
          
          export -f process_script
          export -f calculate_checksums
          
          find . -name "*.user.js" -not -path "./${{ env.USERJS_DIR }}/*" -print0 | 
          while IFS= read -r -d '' file; do
            if process_script "$file"; then
              rm -f "$file"
            else
              exit 1
            fi
          done
          
          echo "processed_count=$(find "${{ env.USERJS_DIR }}" -name "*.user.js" | wc -l)" >> $GITHUB_OUTPUT

      - name: Update README
        if: steps.process.outputs.processed_count > 0
        run: |
          # Create README with enhanced content
          cat > README.md << 'EOL'
          <div align="center">
          
          # ğŸ“¦ Bá»™ SÆ°u Táº­p UserScript
          
          ![Scripts](https://img.shields.io/badge/scripts-${{ steps.process.outputs.processed_count }}-blue?style=flat-square)
          ![Cáº­p nháº­t](https://img.shields.io/github/last-commit/${{ github.repository }}?style=flat-square)
          ![Tráº¡ng thÃ¡i](https://github.com/${{ github.repository }}/actions/workflows/js-producer.yml/badge.svg)
          
          *Bá»™ sÆ°u táº­p UserScript Ä‘Ã£ Ä‘Æ°á»£c tá»‘i Æ°u hÃ³a*
          
          </div>
          
          ## ğŸ“œ Danh SÃ¡ch Script
          
          <table>
          <tr>
          <th>Script</th>
          <th>Chi tiáº¿t</th>
          </tr>
          EOL
          
          get_meta_value() {
            local pattern="$1"
            local file="$2"
            local langs=("vi" "en" "")
            
            for lang in "${langs[@]}"; do
              local suffix=""
              [ -n "$lang" ] && suffix=":$lang"
              local value=$(grep -m 1 "@${pattern}${suffix}" "$file" | sed -E "s/\/\/ @${pattern}${suffix}\s+//")
              [ -n "$value" ] && echo "$value" && return
            done
          }
          
          while IFS= read -r -d '' file; do
            name=$(get_meta_value "name" "$file")
            version=$(grep -m 1 "@version" "$file" | sed -E 's/\/\/ @version\s+//')
            desc=$(get_meta_value "description" "$file")
            author=$(grep -m 1 "@author" "$file" | sed -E 's/\/\/ @author\s+//')
            base=$(basename "$file")
            
            cat >> README.md << EOL
          <tr>
          <td>
          <b>${name}</b><br>
          <small>ğŸ“¦ v${version}</small><br>
          <small>ğŸ‘¤ ${author}</small>
          </td>
          <td>
          <p>${desc}</p>
          <p>
          <a href="https://github.com/${{ github.repository }}/raw/main/${{ env.USERJS_DIR }}/${base}">ğŸ“¥ CÃ i Ä‘áº·t</a> |
          <a href="https://github.com/${{ github.repository }}/blob/main/${{ env.USERJS_DIR }}/${base}">ğŸ“ MÃ£ nguá»“n</a>
          </p>
          </td>
          </tr>
          EOL
          done < <(find "${{ env.USERJS_DIR }}" -name "*.user.js" -print0 | sort -z)
          
          cat >> README.md << 'EOL'
          </table>
          
          ## ğŸ”’ Báº£o máº­t
          
          Táº¥t cáº£ script Ä‘á»u Ä‘Æ°á»£c nÃ©n (minify) Ä‘á»ƒ báº£o vá»‡ vÃ  tá»‘i Æ°u hiá»‡u suáº¥t. XÃ¡c minh tÃ­nh toÃ n váº¹n báº±ng cÃ¡c checksum bÃªn dÆ°á»›i.
          
          <details>
          <summary>ğŸ“ Checksums (SHA-256, MD5, SHA-1)</summary>
          
          \`\`\`
          EOL
          
          cat "${{ env.USERJS_DIR }}/checksums.txt" >> README.md
          
          cat >> README.md << 'EOL'
          \`\`\`
          </details>
          
          ---
          <div align="center">
          <i>Cáº­p nháº­t láº§n cuá»‘i: $(TZ='Asia/Ho_Chi_Minh' date +'%Y-%m-%d %H:%M:%S GMT%z')</i>
          </div>
          EOL

      - name: Commit changes
        if: steps.process.outputs.processed_count > 0
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add "${{ env.USERJS_DIR }}/" README.md
          
          git commit -m "ğŸ“¦ Xá»­ lÃ½ UserScript
          
          Thá»‘ng kÃª:
          - ÄÃ£ xá»­ lÃ½: ${{ steps.process.outputs.processed_count }}/${{ steps.init.outputs.initial_count }}
          - Cáº­p nháº­t: $(TZ='Asia/Ho_Chi_Minh' date +'%Y-%m-%d %H:%M:%S GMT%z')
          
          Thay Ä‘á»•i:
          - âœ¨ Cáº­p nháº­t metadata
          - ğŸ”’ Táº¡o checksums (SHA-256, MD5, SHA-1)
          - ğŸ“ Cáº­p nháº­t README"
          
          git push
